#!/bin/sh

# A handwritten ./configure script, because I kind of hate autotools.
# Â© 2020 Eddie Antonio Santos <easantos@ualberta.ca>

set -e

# see man sysexits
EX_UNAVAILABLE=69
# (nice)

NEWLINE="$(printf '\n ')" && NEWLINE="${IFS% }"
defines=""
libs=""

error() {
  echo "$@" 1>&2
  exit ${EX_UNAVAILABLE}
}

_link_test_program() {
  funcname=$1
  lib=$2
  cc=${CC:-gcc}

  printf 'checking to link with lib%s (checking with %s())... ' "$lib" "$funcname"

  filename="${TMPDIR}/conftest.$$.c"

  cat > "${filename}" <<EOF
    char ${funcname}(void);

    int main(void) {
      return ${funcname}();
    }
EOF

  if ${cc} -o /dev/null "-l${lib}" "${filename}"; then
    echo "yes"
    return 0
  else
    echo "no"
    return 1
  fi
}

# -lcurses (required)
if _link_test_program tigetnum curses ; then
  libs="${libs} -lcurses"
else
  error "ncurses is required for compilation"
fi


# -lpng (optional)
if _link_test_program png_create_info_struct png ; then
  defines="${defines}#define cimg_use_png 1${NEWLINE}"
  libs="${libs} -lpng"
fi

# -ljpg
if _link_test_program jpeg_set_defaults jpeg ; then
  defines="${defines}#define cimg_use_jpeg 1${NEWLINE}"
  libs="${libs} -ljpeg"
fi

cat > config.mk <<EOF
# AUTOGENERATED FILE! DO NO MODIFY!
LIBS = ${libs}
EOF
